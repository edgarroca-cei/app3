workflows:
  ios-unsigned:
    name: iOS Unsigned IPA
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      node: latest
      xcode: latest
      cocoapods: default
    scripts:
      - name: Install dependencies
        script: npm install
      - name: Prebuild Expo App
        script: npx expo prebuild -p ios
      - name: Set Update Channel
        script: |
          PLIST_PATH=$(find ios -name Expo.plist | head -n 1)
          echo "Found Expo.plist at: $PLIST_PATH"
          /usr/libexec/PlistBuddy -c "Add :EXPO_UPDATES_CHANNEL_NAME string production" "$PLIST_PATH" || /usr/libexec/PlistBuddy -c "Set :EXPO_UPDATES_CHANNEL_NAME production" "$PLIST_PATH"
          cat "$PLIST_PATH"
      - name: Install CocoaPods
        script: |
          cd ios
          pod install
      - name: Build Unsigned IPA
        script: |
          cd ios
          xcodebuild build \
            -workspace app3.xcworkspace \
            -scheme app3 \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ../ios_build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=NO
      - name: Package IPA
        script: |
          mkdir -p Payload
          mv ios_build/Build/Products/Release-iphoneos/app3.app Payload/
          zip -r app3.ipa Payload
    artifacts:
      - app3.ipa
